<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./style/style.css" />
    <title>SORA</title>
    <!--jQuery here-->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <!--Select2-->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.5/pagination.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.5/pagination.min.js"></script> -->

    <!--axios-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.20.0/axios.js"></script>
</head>

<body>
    <header class="nav_header">
        <nav>
            <div class="logo">
                <a class="logolink" href="./search.html">SORA</a>
            </div>
            <div class="modify_search" id="modify_search">修改搜尋條件</div>
            <div id="hide_search">隱藏搜尋條件</div>
        </nav>
    </header>
    <!--prototype filter-->
    <!-- <div>
        <form action="/search_experiment" method="post">
            <label for="first">Option 1</label>
            <input type="text" name="first" value="高雄" />
            <label for="second">Option 2</label>
            <input type="text" name="second" value="櫻花" />
            <label for="third">Option 3</label>
            <input type="text" name="third" value="2300" />
            <button id="fire">Search</button>
        </form>
    </div> -->

    <div id="root">
        <div id="filters">
            <div>
                <label for="id_label_1">
            地點
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_1"
            >
              <option value="TPE">台北</option>
              <option value="KAO">高雄</option>
              <option value="NTP">新北</option>
              <option value="TAN">台南</option>
              <option value="HSC">新竹</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_2">
            異國料理
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_2"
            >
              <option value="TPE">日式</option>
              <option value="KAO">中式</option>
              <option value="NTP">韓式</option>
              <option value="TAN">美式</option>
              <option value="HSC">泰式</option>
              <option value="HSC">港式</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_3">
            餐廳類型
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_3"
            >
              <option value="TPE">咖啡廳</option>
              <option value="KAO">居酒屋</option>
              <option value="NTP">餐酒館</option>
              <option value="TAN">酒吧</option>
              <option value="HSC">甜點店</option>
              <option value="HSC">火鍋店</option>
              <option value="TAN">茶館</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_4">
            餐點名稱
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_4"
            >
              <option value="TAN">炸魚薯條</option>
              <option value="TPE">炸豬排</option>
              <option value="KAO">松鼠桂魚</option>
              <option value="NTP">麻婆豆腐</option>
              <option value="TAN">時雨煮</option>
              <option value="HSC">三種起司披薩</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_5">
            價位
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_5"
            >
              <option value="TPE">$</option>
              <option value="KAO">$$</option>
              <option value="NTP">$$$</option>
              <option value="TAN">$$$$</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_6">
            評價(幾分以上)
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_6"
            >
              <option value="TPE">1</option>
              <option value="KAO">2</option>
              <option value="NTP">3</option>
              <option value="TAN">4</option>
              <option value="HSC">4.5</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_7">
            供餐時段
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_7"
            >
              <option value="TPE">早餐</option>
              <option value="KAO">早午餐</option>
              <option value="NTP">午餐</option>
              <option value="TAN">下午茶</option>
              <option value="HSC">晚餐</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_8">
            服務
            <select
              class="js-example-basic-multiple"
              name="states[]"
              multiple="multiple"
              id="id_label_8"
            >
              <option value="TPE">外帶</option>
              <option value="KAO">外送</option>
              <option value="NTP">寵物友善</option>
              <option value="TAN">兒童座椅</option>
              <option value="HSC">停車場</option>
              <option value="PLUG">插座</option>
              <option value="PLUG">吃到飽</option>
              <option value="PLUG">預約制</option>
            </select>
          </label>
            </div>
            <div>
                <label for="id_label_9">
            營業中
            <select
              class="js-example-basic-single"
              name="states"
              id="id_label_9"
            >
              <option value="TRUE">是</option>
              <option value="FALSE">否</option>
            </select>
          </label>
            </div>
            <div>
                <button id="selected_fire">SORA!!</button>
            </div>
        </div>
    </div>
    <script>
        let cnt = 0;
        let hits_arr = [];
        let page_len = 0;

        $(document).ready(() => {
            $(".js-example-basic-multiple").select2({
                tags: true,
            });
        });
        $("#hide_search").hide();
        $("#modify_search").hide();

        // $("html").dblclick(() => {
        //     cnt = 0;
        // });
        // $("#root").html("panzer vor!");
        // $("#root").html("panzer vor!");
        // let intervalID = setInterval(() => {
        //     $("#root").append(`<p>${cnt}</p>`);
        //     cnt++;
        //     if (cnt > 10) window.clearInterval(intervalID);
        // }, 1000);
        let place = $("#id_label_1"),
            exotic = $("#id_label_2"),
            estab = $("#id_label_3"),
            menu = $("#id_label_4"),
            pricelv = $("#id_label_5"),
            rating = $("#id_label_6"),
            ophour = $("#id_label_7"),
            amenit = $("#id_label_8"),
            opennow = $("#id_label_9");

        // $("#fire").click((e) => {
        //     e.preventDefault();
        //     //console.log("first input: ", $('input[name="first"]').val());
        //     axios
        //         .post(
        //             "http://localhost:3000/search_experiment", {
        //                 // first: "高雄",
        //                 // second: "櫻花",
        //                 // third: "2200",
        //                 first: $('input[name="first"]').val(),
        //                 second: $('input[name="second"]').val(),
        //                 third: $('input[name="third"]').val(),
        //             }, {
        //                 Headers: {
        //                     "Access-Control-Allow-Origin": "*",
        //                     "Content-Type": "application/json",
        //                 },
        //             }
        //         )
        //         .then((response) => {
        //             const data = response.data;
        //             $("#root").append(`<p>${JSON.stringify(data.hits)}</p>`);
        //             console.log(data);
        //             console.log("success");
        //         })
        //         .catch((error) => {
        //             console.log("An error occurred:", error);
        //         })
        //         .finally(() => {
        //             console.log("finally");
        //         });
        // });
        $("#selected_fire").click((event) => {
            $(".pagination").remove();
            let place_arr = [];
            let selected_place = place.find(":selected");
            for (i of selected_place) {
                place_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let exotic_arr = [];
            let selected_exotic = exotic.find(":selected");
            for (i of selected_exotic) {
                exotic_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let estab_arr = [];
            let selected_estab = estab.find(":selected");
            for (i of selected_estab) {
                estab_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let menu_arr = [];
            let selected_menu = menu.find(":selected");
            for (i of selected_menu) {
                menu_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let pricelv_arr = [];
            let selected_pricelv = pricelv.find(":selected");
            for (i of selected_pricelv) {
                pricelv_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let rating_arr = [];
            let selected_rating = rating.find(":selected");
            for (i of selected_rating) {
                rating_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let ophour_arr = [];
            let selected_ophour = ophour.find(":selected");
            for (i of selected_ophour) {
                ophour_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let amenit_arr = [];
            let selected_amenit = amenit.find(":selected");
            for (i of selected_amenit) {
                amenit_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            let opennow_arr = [];
            let selected_opennow = opennow.find(":selected");
            for (i of selected_opennow) {
                opennow_arr.push(i.innerHTML);
                //console.log("i.innerHTML: ", i.innerHTML);
            }

            // console.log("sel_place: ", sel_place);
            // $("#root").append(`<p>${sel_place}</p>`);

            axios
                .post(
                    "http://localhost:3000/search_experiment", {
                        place: place_arr, //formatted_address
                        exotic: exotic_arr, //reviews.text
                        estab: estab_arr, //reviews.text
                        menu: menu_arr, //reviews.text
                        pricelv: pricelv_arr,
                        rating: rating_arr,
                        ophour: ophour_arr, ////reviews.text e.g.早餐，午餐，晚餐
                        amenit: amenit_arr, //reviews.text
                        opennow: opennow_arr, //
                    }, {
                        Headers: {
                            "Access-Control-Allow-Origin": "*",
                            "Content-Type": "application/json",
                        },
                    }
                )
                .then((response) => {
                    const data = response.data;
                    //$("#root").append(`<p>${JSON.stringify(data.hits)}</p>`);
                    console.log(data);
                    $("#restaurant_container").remove();
                    $("#detail_display").remove();

                    hits_arr = [];
                    page_len = data.hits.hits.length;
                    data.hits.hits.forEach((element, index) => {
                        // if (index !== 0) {
                        //     return;
                        // }
                        hits_arr.push(element._source);
                    });
                    console.log("length of hits_arr: ", hits_arr.length);
                    let cnt = 0;
                    let div_container = $("<div></div>").attr({
                        id: "restaurant_container",
                    });
                    let div_membrane = $("<div></div>").attr({
                        id: "restaurant_membrane",
                    });
                    $("#root").append(div_container);
                    $("#restaurant_container").append(div_membrane);

                    for (h of hits_arr) {
                        let div_box = $("<div></div>").attr({
                            id: `h${cnt}`,
                            class: "restaurant_box",
                        });
                        //$("#restaurant_container").append(div_box);
                        div_membrane.append(div_box);

                        div_box.append(
                            `<p class="item_name" id="item_title_${cnt}">名稱：${cnt + 1}.${
                  h.name
                }</p>`
                        );

                        div_box.append(
                            `<p class="item_address">地址：${h.formatted_address}</p>`
                        );
                        div_box.append(`<p class="item_rating">評分：${h.rating}</p>`);

                        let plv = h.price_level;
                        if (!plv) {
                            plv = 0;
                        } else {
                            const plv_cnt = plv;
                            plv = "";
                            for (i = 0; i < plv_cnt; i++) {
                                plv += "$";
                            }
                        }
                        div_box.append(`<p class="item_pricing">價位：${plv}</p>`);

                        let opening_hours;
                        try {
                            opening_hours = h.opening_hours.weekday_text;
                        } catch (err) {
                            console.log(
                                "An error occurred, might haven't caught data weekday_text correctly:",
                                err
                            );
                            opening_hours = "無資料";
                        }

                        div_box.append(
                            `<p class="item_ophour">營業時間：${opening_hours}</p>`
                        );
                        let today = new Date();
                        today = today.getDay();
                        let opendays = new Set();
                        try {
                            const period = h.opening_hours.periods;
                            for (p of period) {
                                for (k of Object.keys(p)) {
                                    if (p[k]["day"]) {
                                        //console.log("p[k]['day']: ", p[k]["day"]);
                                        opendays.add(p[k]["day"]);
                                    }
                                }
                            }
                        } catch (err) {
                            console.log(
                                "An error occurred, might haven't caught data periods correctly:",
                                err,
                                "will set all days open for the time being"
                            );
                            opendays.add(-2147483648);
                        }
                        //console.log("opendays: ", opendays);
                        div_box.append(
                            `<p class="item_ophour">營業日：${Array.from(opendays).join(
                  "-"
                )}</p>`
                        );
                        div_box.append(`<p>今天星期${today}</p>`);

                        cnt++;
                    }
                    (function($) {
                        let pagify = {
                            items: {},
                            container: null,
                            totalPages: 1,
                            perPage: 3,
                            currentPage: 0,
                            createNavigation: function() {
                                this.totalPages = Math.ceil(this.items.length / this.perPage);
                                console.log("total pages: ", this.totalPages);

                                $(".pagination", this.container.parent()).remove();
                                let pagination = $(
                                    '<div class="pagination" id="pagination"></div>'
                                ).append(
                                    '<a class="nav prev disabled" data-next="false"><</a>'
                                );

                                for (let i = 0; i < this.totalPages; i++) {
                                    let pageElClass = "page";
                                    if (!i) pageElClass = "page current";
                                    let pageEl =
                                        '<a class="' +
                                        pageElClass +
                                        '" data-page="' +
                                        (i + 1) +
                                        '">' +
                                        (i + 1) +
                                        "</a>";
                                    pagination.append(pageEl);
                                }
                                pagination.append(
                                    '<a class="nav next" data-next="true">></a>'
                                );

                                this.container.after(pagination);

                                let that = this;
                                $("body").off("click", ".nav");
                                this.navigator = $("body").on("click", ".nav", function() {
                                    let el = $(this);
                                    that.navigate(el.data("next"));
                                });

                                $("body").off("click", ".page");
                                this.pageNavigator = $("body").on(
                                    "click",
                                    ".page",
                                    function() {
                                        let el = $(this);
                                        that.goToPage(el.data("page"));
                                    }
                                );
                            },
                            navigate: function(next) {
                                // default perPage to 5
                                if (isNaN(next) || next === undefined) {
                                    next = true;
                                }
                                $(".pagination .nav").removeClass("disabled");
                                if (next) {
                                    this.currentPage++;
                                    if (this.currentPage > this.totalPages - 1)
                                        this.currentPage = this.totalPages - 1;
                                    if (this.currentPage == this.totalPages - 1)
                                        $(".pagination .nav.next").addClass("disabled");
                                } else {
                                    this.currentPage--;
                                    if (this.currentPage < 0) this.currentPage = 0;
                                    if (this.currentPage == 0)
                                        $(".pagination .nav.prev").addClass("disabled");
                                }

                                this.showItems();
                            },
                            updateNavigation: function() {
                                let pages = $(".pagination .page");
                                pages.removeClass("current");
                                $(
                                    '.pagination .page[data-page="' +
                                    (this.currentPage + 1) +
                                    '"]'
                                ).addClass("current");
                            },
                            goToPage: function(page) {
                                this.currentPage = page - 1;

                                $(".pagination .nav").removeClass("disabled");
                                if (this.currentPage == this.totalPages - 1)
                                    $(".pagination .nav.next").addClass("disabled");

                                if (this.currentPage == 0)
                                    $(".pagination .nav.prev").addClass("disabled");
                                this.showItems();
                            },
                            showItems: function() {
                                this.items.hide();
                                let base = this.perPage * this.currentPage;
                                this.items.slice(base, base + this.perPage).show();

                                this.updateNavigation();
                            },
                            init: function(container, items, perPage) {
                                this.container = container;
                                this.currentPage = 0;
                                this.totalPages = 1;
                                this.perPage = perPage;
                                this.items = items;
                                this.createNavigation();
                                this.showItems();
                            },
                        };

                        // stuff it all into a jQuery method!
                        $.fn.pagify = function(perPage, itemSelector) {
                            let el = $(this);
                            let items = $(itemSelector, el);

                            // default perPage to 5
                            if (isNaN(perPage) || perPage === undefined) {
                                perPage = 3;
                            }

                            // don't fire if fewer items than perPage
                            if (items.length <= perPage) {
                                return true;
                            }

                            pagify.init(el, items, perPage);
                        };
                    })(jQuery);

                    if (hits_arr.length === 0) {
                        let empty_reminder_box = $("<div></div>");
                        let empty_reminder_p = $("<p>沒有你要找的餐廳</p>");
                        empty_reminder_box.append(empty_reminder_p);
                        div_membrane.append(empty_reminder_box);
                    }

                    $("#restaurant_container").pagify(10, ".restaurant_box");
                    $("#hide_search").show();
                    $("#modify_search").show();
                    $("#filters").hide();
                    console.log("success");
                })
                .catch((error) => {
                    console.log("An error occurred:", error);
                })
                .finally(() => {
                    console.log("finally");
                });

            // const print_data = `text_select_1: ,
            //   ${text_select_1},
            //   ${text_select_1.text()},
            //   ${text_select_1[0]},
            //   ${text_select_1.length},
            //   ${text_select_1[0].innerHTML},
            //   text_select_2: ,
            //   ${text_select_2.text()},
            //   text_select_3: ,
            //   ${text_select_3.text()}`;
            // console.log(
            //     // "val_select_1: ",
            //     // val_select_1,
            //     // "\nval_select_1: ",
            //     // val_select_1,
            //     // "\nval_select_1: ",
            //     // val_select_1,
            //     print_data
            // );
            // console.log(text_select_1);
            // console.log(text_select_1.text());
            // console.log(text_select_1[0]);
            // console.log(text_select_1.length);
            // console.log(text_select_1[0].innerHTML);
            // $("#root").append(`<div>${print_data}</div>`);
            //get length of selected options
            // $("#root").append(`<p>${text_select_1.length}</p>`);
            // $("#root").append(`<p>${text_select_2.length}</p>`);
        });
        $("#modify_search").click((event) => {
            $("#filters").show();
        });
        $("#hide_search").click((event) => {
            $("#filters").hide();
        });
        let test_cnt = 0;
        // for (let i = 0; i < page_len; i++) is not gonna working
        // The value 100 here is correspondent with the size of results elasticsearch returns.
        // Try enable assigning value to it in runtime in the future.
        for (let i = 0; i < 100; i++) {
            $(document).on("click", `#item_title_${i}`, () => {
                let detail_data = hits_arr[i];
                //console.log("the data is: ", JSON.stringify(detail_data));
                let detail_layout = $("<div></div>").attr({
                    id: "detail_display",
                });
                $("#root").append(detail_layout);
                detail_layout.append(
                    `<p id="detail_name">名稱：${detail_data.name}</p>`
                );
                detail_layout.append(
                    `<p class="item_address">地址：${detail_data.formatted_address}</p>`
                );
                detail_layout.append(
                    `<p class="item_rating">評分：${detail_data.rating}</p>`
                );
                let plv = detail_data.price_level;
                if (!plv) {
                    plv = 0;
                } else {
                    const plv_cnt = plv;
                    plv = "";
                    for (i = 0; i < plv_cnt; i++) {
                        plv += "$";
                    }
                }
                detail_layout.append(`<p class="item_pricing">價位：${plv}</p>`);
                let opening_hours;
                try {
                    opening_hours = detail_data.opening_hours.weekday_text;
                } catch (err) {
                    console.log(
                        "An error occurred, might haven't caught data weekday_text correctly:",
                        err
                    );
                    opening_hours = "無資料";
                }

                detail_layout.append(
                    `<p class="item_ophour">營業時間：${opening_hours}</p>`
                );
                let today = new Date();
                today = today.getDay();
                let opendays = new Set();
                try {
                    const period = detail_data.opening_hours.periods;
                    for (p of period) {
                        for (k of Object.keys(p)) {
                            if (Object.prototype.hasOwnProperty.call(p[k], "day")) {
                                //console.log("p[k]['day']: ", p[k]["day"]);
                                opendays.add(p[k]["day"]);
                            }
                        }
                    }
                } catch (err) {
                    console.log(
                        "An error occurred, might haven't caught data periods correctly:",
                        err,
                        "will set all days open for the time being"
                    );
                    opendays.add(-2147483648);
                }
                //console.log("opendays: ", opendays);
                detail_layout.append(
                    `<p class="item_ophour">營業日：${Array.from(opendays).join(
              "-"
            )}</p>`
                );
                detail_layout.append(`<p>今天星期${today}</p>`);
                detail_layout.append("<br>");
                detail_layout.append("<br>");
                if (detail_data.formatted_phone_number != undefined) {
                    detail_layout.append(
                        `<p>電話：${detail_data.formatted_phone_number}</p>`
                    );
                } else {
                    detail_layout.append(`<p>電話：沒有資料</p>`);
                }

                if (detail_data.website != undefined) {
                    detail_layout.append(`<p>網站：${detail_data.website}</p>`);
                } else {
                    detail_layout.append(`<p>網站：沒有資料</p>`);
                }

                let reviews_div = $("<div></div>").attr({
                    id: `reviews_container`,
                });
                detail_layout.append(reviews_div);
                let cnt = 0;
                try {
                    for (r of detail_data.reviews) {
                        let single_review = $("<div></div>").attr({
                            id: `reviews_no_${cnt}`,
                            class: "review_box",
                        });
                        reviews_div.append(single_review);
                        //
                        single_review.append(`<p>姓名：${r.author_name}</p>`);
                        single_review.append(`<p>評分：${r.rating}</p>`);
                        single_review.append(`<p>評論：${r.text}</p>`);
                        cnt += 1;
                    }
                } catch (err) {
                    console.log("An error occurred while rendering reviews:", err);

                    let single_review = $("<div></div>").attr({
                        id: `reviews_no_${cnt}`,
                        class: "review_box",
                    });
                    reviews_div.append(single_review);
                    single_review.append(`<p>目前還沒有評論~</p>`);
                }

                //$("#root").append(`<p>${JSON.stringify(hits_arr[i])}</p>`);

                $("#restaurant_container").remove();
                $("#pagination").remove();
            });
        }
        // let container = $("#filters");
        // container.pagination
    </script>
</body>

</html>